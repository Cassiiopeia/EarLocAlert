name: PROJECT-iOS-TestFlight-Deploy

on:
  push:
    branches: ["deploy"]
  workflow_run:
    workflows: ["CHANGELOG ìë™ ì—…ë°ì´íŠ¸"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

# ============================================
# ğŸ”§ í”„ë¡œì íŠ¸ë³„ ì„¤ì • (ì•„ë˜ ê°’ë“¤ì„ ìˆ˜ì •í•˜ì„¸ìš”)
# ============================================
env:
  # í”„ë¡œì íŠ¸ ì´ë¦„
  PROJECT_NAME: "your-project"
  FLUTTER_VERSION: "3.35.5"
  XCODE_VERSION: "16.3"
  PROJECT_TYPE: "flutter"

  # iOS ì•± ì„¤ì • (ì‹œí¬ë¦¿ìœ¼ë¡œ ê´€ë¦¬í•˜ê±°ë‚˜ ì—¬ê¸°ì— í•˜ë“œì½”ë”©)
  # Bundle ID, Team ID, Provisioning Profile ì´ë¦„ì€ ì‹œí¬ë¦¿ ì‚¬ìš© ê¶Œì¥
  # IOS_BUNDLE_ID: ì‹œí¬ë¦¿ ${{ secrets.IOS_BUNDLE_ID }} ì‚¬ìš©
  # APPLE_TEAM_ID: ì‹œí¬ë¦¿ ${{ secrets.APPLE_TEAM_ID }} ì‚¬ìš©
  # IOS_PROVISIONING_PROFILE_NAME: ì‹œí¬ë¦¿ ${{ secrets.IOS_PROVISIONING_PROFILE_NAME }} ì‚¬ìš©

jobs:
  prepare-build:
    name: í™˜ê²½ ì„¤ì • ë° ì¤€ë¹„
    runs-on: macos-15
    # CHANGELOG ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}

    outputs:
      version: ${{ steps.current_version.outputs.version }}
      build_number: ${{ steps.current_version.outputs.build_number }}
      project_type: ${{ steps.current_version.outputs.project_type }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin deploy

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo ".env file created"

      - name: Create Secrets.xcconfig file
        run: |
          mkdir -p ios/Flutter
          if [ -n "${{ secrets.SECRETS_XCCONFIG }}" ]; then
            echo "${{ secrets.SECRETS_XCCONFIG }}" > ios/Flutter/Secrets.xcconfig
            echo "Secrets.xcconfig created"
          else
            echo "// No secrets provided" > ios/Flutter/Secrets.xcconfig
          fi

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true
          working-directory: ios

      - name: Install CocoaPods
        run: |
          cd ios
          bundle install || gem install cocoapods
          pod install

      # ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
      - name: ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
        run: |
          chmod +x ./.github/scripts/version_manager.sh
          chmod +x ./.github/scripts/changelog_manager.py

      # version_manager.shë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ë²„ì „ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      - name: í˜„ì¬ ë²„ì „ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        id: current_version
        run: |
          # version_manager.shë¡œ ë²„ì „ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (version.yml ê¸°ë°˜)
          VERSION=$(./.github/scripts/version_manager.sh get | tail -n 1)
          BUILD_NUMBER=$(./.github/scripts/version_manager.sh get-code | tail -n 1)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "project_type=${{ env.PROJECT_TYPE }}" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ ë²„ì „: $VERSION (ë¹Œë“œë²ˆí˜¸: $BUILD_NUMBER)"

      # CHANGELOG.jsonì—ì„œ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ - changelog_manager.py ì‚¬ìš©
      - name: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        id: release_notes
        run: |
          VERSION="${{ steps.current_version.outputs.version }}"

          if [ -f "CHANGELOG.json" ]; then
            echo "ğŸ“„ CHANGELOG.jsonì—ì„œ v$VERSION ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì¤‘..."
            # CHANGELOG.md ìƒì„±
            python3 ./.github/scripts/changelog_manager.py generate-md

            # changelog_manager.py exportë¡œ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ
            python3 ./.github/scripts/changelog_manager.py export --version $VERSION --output final_release_notes.txt

            if [ -s final_release_notes.txt ]; then
              echo "âœ… ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì„±ê³µ!"
              echo "ğŸ“‹ ì¶”ì¶œëœ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸:"
              echo "----------------------------------------"
              cat final_release_notes.txt
              echo "----------------------------------------"
              echo "RELEASE_NOTES_FOUND=true" >> $GITHUB_ENV
            else
              echo "âŒ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨"
              echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
              echo "v$VERSION ì—…ë°ì´íŠ¸" > final_release_notes.txt
            fi
          else
            echo "âš ï¸ CHANGELOG.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
            echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
            echo "v$VERSION ì—…ë°ì´íŠ¸" > final_release_notes.txt
          fi

      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: final_release_notes.txt
          retention-days: 1

  # ============================================
  # iOS ë¹Œë“œ ë° TestFlight ë°°í¬ (Fastlane ì‚¬ìš©)
  # ============================================
  build-and-deploy:
    name: iOS ë¹Œë“œ ë° TestFlight ë°°í¬
    runs-on: macos-15
    needs: prepare-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin deploy

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      # .env íŒŒì¼ ìƒì„±
      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo "âœ… .env íŒŒì¼ ìƒì„±ë¨ (í¬ê¸°: $(wc -c < .env) bytes)"

      # Secrets.xcconfig íŒŒì¼ ìƒì„±
      - name: Create Secrets.xcconfig file
        run: |
          mkdir -p ios/Flutter
          if [ -n "${{ secrets.SECRETS_XCCONFIG }}" ]; then
            echo "${{ secrets.SECRETS_XCCONFIG }}" > ios/Flutter/Secrets.xcconfig
            echo "âœ… Secrets.xcconfig ìƒì„±ë¨"
          else
            echo "// No secrets provided" > ios/Flutter/Secrets.xcconfig
            echo "âš ï¸ SECRETS_XCCONFIGì´ ë¹„ì–´ìˆì–´ ê¸°ë³¸ê°’ ì‚¬ìš©"
          fi

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true
          working-directory: ios

      - name: Install Bundler dependencies
        run: |
          cd ios
          if [ -f "Gemfile" ]; then
            bundle install
          else
            gem install fastlane cocoapods
          fi

      - name: Install CocoaPods
        run: cd ios && pod install

      # Apple ì¸ì¦ì„œ ì„¤ì •
      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Install Provisioning Profile
        run: |
          echo "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          uuid=$(grep -A1 -a "UUID" profile.mobileprovision | grep string | sed -e "s/<string>//" -e "s/<\/string>//" -e "s/[[:space:]]//g")
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$uuid.mobileprovision
          echo "âœ… Provisioning Profile ì„¤ì¹˜ë¨: $uuid"

      # App Store Connect API Key ì„¤ì •
      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
          echo "âœ… API Key ì„¤ì • ì™„ë£Œ"

      # Flutter ë¹Œë“œ (no-codesign)
      - name: Flutter build (no codesign)
        run: |
          flutter build ios --release --no-codesign \
            --build-name="${{ needs.prepare-build.outputs.version }}" \
            --build-number="${{ needs.prepare-build.outputs.build_number }}"

      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      # Fastlaneìœ¼ë¡œ ë¹Œë“œ ë° ë°°í¬
      - name: Build and Deploy with Fastlane
        env:
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          IOS_PROVISIONING_PROFILE_NAME: ${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          API_KEY_PATH: ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
        run: |
          # Release notes ì¤€ë¹„
          if [ -f "final_release_notes.txt" ]; then
            export RELEASE_NOTES=$(cat final_release_notes.txt)
            echo "ğŸ“‹ Release Notes í¬í•¨í•˜ì—¬ ë°°í¬:"
            echo "$RELEASE_NOTES"
          else
            export RELEASE_NOTES="v${{ needs.prepare-build.outputs.version }} ì—…ë°ì´íŠ¸"
            echo "ğŸ“‹ ê¸°ë³¸ Release Notesë¡œ ë°°í¬: $RELEASE_NOTES"
          fi

          cd ios

          # Fastfileì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒì„±
          if [ ! -f "fastlane/Fastfile" ]; then
            echo "âš ï¸ Fastfileì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ Fastfile ìƒì„± ì¤‘..."
            mkdir -p fastlane
            cat > fastlane/Fastfile << 'FASTFILE'
          default_platform(:ios)

          platform :ios do
            desc "TestFlightì— ì•± ì—…ë¡œë“œ"
            lane :deploy_testflight do
              UI.message("ğŸš€ TestFlight ë°°í¬ ì‹œì‘")
              UI.message("   Bundle ID: #{ENV['IOS_BUNDLE_ID']}")
              UI.message("   Team ID: #{ENV['APPLE_TEAM_ID']}")

              api_key = app_store_connect_api_key(
                key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
                issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
                key_filepath: ENV["API_KEY_PATH"],
                duration: 1200,
                in_house: false
              )

              build_app(
                workspace: "Runner.xcworkspace",
                scheme: "Runner",
                export_method: "app-store",
                output_directory: "build/ipa",
                output_name: "Runner.ipa",
                clean: true,
                export_options: {
                  method: "app-store",
                  teamID: ENV["APPLE_TEAM_ID"],
                  signingStyle: "manual",
                  signingCertificate: "Apple Distribution",
                  provisioningProfiles: {
                    ENV["IOS_BUNDLE_ID"] => ENV["IOS_PROVISIONING_PROFILE_NAME"]
                  }
                },
                skip_profile_detection: true,
                xcargs: "-allowProvisioningUpdates CODE_SIGN_STYLE=Manual CODE_SIGN_IDENTITY='Apple Distribution' DEVELOPMENT_TEAM='#{ENV['APPLE_TEAM_ID']}'"
              )

              UI.success("âœ… IPA ë¹Œë“œ ì™„ë£Œ")

              upload_to_testflight(
                api_key: api_key,
                ipa: "build/ipa/Runner.ipa",
                changelog: ENV["RELEASE_NOTES"] || "ìƒˆë¡œìš´ ë¹Œë“œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.",
                skip_waiting_for_build_processing: true,
                distribute_external: false,
                notify_external_testers: false,
                uses_non_exempt_encryption: false
              )

              UI.success("âœ… TestFlight ì—…ë¡œë“œ ì™„ë£Œ!")
            end
          end
          FASTFILE
          fi

          # Fastlane ì‹¤í–‰
          echo "ğŸš€ Fastlane ì‹¤í–‰ ì¤‘..."
          if [ -f "Gemfile" ]; then
            bundle exec fastlane deploy_testflight
          else
            fastlane deploy_testflight
          fi

      # ì„±ê³µ ì•Œë¦¼
      - name: Notify TestFlight Upload Success
        if: success()
        run: |
          echo "âœ… TestFlight ì—…ë¡œë“œ ì„±ê³µ!"
          echo "ë²„ì „: ${{ needs.prepare-build.outputs.version }}"
          echo "ë¹Œë“œë²ˆí˜¸: ${{ needs.prepare-build.outputs.build_number }}"
          echo "ì»¤ë°‹: ${{ github.sha }}"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ TestFlight ì—…ë¡œë“œ ì‹¤íŒ¨!"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
