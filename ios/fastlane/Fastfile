# ===================================================================
# Fastlane Fastfile - iOS ë¹Œë“œ ë° ë°°í¬ ìë™í™”
# ===================================================================
#
# ì‚¬ìš©ë²•:
#   bundle exec fastlane deploy_testflight
#
# í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ (GitHub Secrets):
#   - IOS_BUNDLE_ID: ì•± Bundle ID
#   - APPLE_TEAM_ID: Apple Developer Team ID
#   - IOS_PROVISIONING_PROFILE_NAME: Provisioning Profile ì´ë¦„
#   - APP_STORE_CONNECT_API_KEY_ID: API Key ID
#   - APP_STORE_CONNECT_ISSUER_ID: Issuer ID
#   - API_KEY_PATH: API Key íŒŒì¼ ê²½ë¡œ
#
# ===================================================================

default_platform(:ios)

platform :ios do

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # TestFlight ë°°í¬ Lane
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "TestFlightì— ì•± ì—…ë¡œë“œ"
  lane :deploy_testflight do

    # í™˜ê²½ë³€ìˆ˜ ê²€ì¦
    UI.user_error!("IOS_BUNDLE_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤") unless ENV["IOS_BUNDLE_ID"]
    UI.user_error!("APPLE_TEAM_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤") unless ENV["APPLE_TEAM_ID"]
    UI.user_error!("IOS_PROVISIONING_PROFILE_NAMEì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤") unless ENV["IOS_PROVISIONING_PROFILE_NAME"]
    UI.user_error!("APP_STORE_CONNECT_API_KEY_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤") unless ENV["APP_STORE_CONNECT_API_KEY_ID"]
    UI.user_error!("APP_STORE_CONNECT_ISSUER_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤") unless ENV["APP_STORE_CONNECT_ISSUER_ID"]
    UI.user_error!("API_KEY_PATHê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤") unless ENV["API_KEY_PATH"]

    UI.message("ğŸš€ TestFlight ë°°í¬ ì‹œì‘")
    UI.message("   Bundle ID: #{ENV['IOS_BUNDLE_ID']}")
    UI.message("   Team ID: #{ENV['APPLE_TEAM_ID']}")
    UI.message("   Profile: #{ENV['IOS_PROVISIONING_PROFILE_NAME']}")

    # App Store Connect API Key ì„¤ì •
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: ENV["API_KEY_PATH"],
      duration: 1200,
      in_house: false
    )

    # Archive ë° IPA ìƒì„±
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "build/ipa",
      output_name: "Runner.ipa",
      clean: true,

      # ì½”ë“œ ì„œëª… ì„¤ì • (Runner íƒ€ê²Ÿì—ë§Œ ì ìš©)
      export_options: {
        method: "app-store",
        teamID: ENV["APPLE_TEAM_ID"],
        signingStyle: "manual",
        signingCertificate: "Apple Distribution",
        provisioningProfiles: {
          ENV["IOS_BUNDLE_ID"] => ENV["IOS_PROVISIONING_PROFILE_NAME"]
        }
      },

      # CI í™˜ê²½ì—ì„œ Manual Signing ê°•ì œ
      skip_profile_detection: true,

      # xcargsë¡œ ë¹Œë“œ ì„¤ì • ì „ë‹¬ - Manual Signing ëª…ì‹œ
      xcargs: "-allowProvisioningUpdates " \
              "DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']} " \
              "CODE_SIGN_STYLE=Manual " \
              "CODE_SIGN_IDENTITY='Apple Distribution' " \
              "PROVISIONING_PROFILE_SPECIFIER='#{ENV['IOS_PROVISIONING_PROFILE_NAME']}'"
    )

    UI.success("âœ… IPA ë¹Œë“œ ì™„ë£Œ")

    # TestFlight ì—…ë¡œë“œ
    upload_to_testflight(
      api_key: api_key,
      ipa: "build/ipa/Runner.ipa",
      changelog: ENV["RELEASE_NOTES"] || "ìƒˆë¡œìš´ ë¹Œë“œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.",
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      notify_external_testers: false,
      uses_non_exempt_encryption: false
    )

    UI.success("âœ… TestFlight ì—…ë¡œë“œ ì™„ë£Œ!")
  end

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ë¹Œë“œë§Œ ìˆ˜í–‰ (ì—…ë¡œë“œ ì—†ìŒ)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "IPA ë¹Œë“œë§Œ ìˆ˜í–‰ (í…ŒìŠ¤íŠ¸ìš©)"
  lane :build_only do

    UI.user_error!("IOS_BUNDLE_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤") unless ENV["IOS_BUNDLE_ID"]
    UI.user_error!("APPLE_TEAM_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤") unless ENV["APPLE_TEAM_ID"]
    UI.user_error!("IOS_PROVISIONING_PROFILE_NAMEì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤") unless ENV["IOS_PROVISIONING_PROFILE_NAME"]

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "build/ipa",
      output_name: "Runner.ipa",
      clean: true,
      export_options: {
        method: "app-store",
        teamID: ENV["APPLE_TEAM_ID"],
        signingStyle: "manual",
        signingCertificate: "Apple Distribution",
        provisioningProfiles: {
          ENV["IOS_BUNDLE_ID"] => ENV["IOS_PROVISIONING_PROFILE_NAME"]
        }
      },

      # CI í™˜ê²½ì—ì„œ Manual Signing ê°•ì œ
      skip_profile_detection: true,

      # xcargsë¡œ ë¹Œë“œ ì„¤ì • ì „ë‹¬ - Manual Signing ëª…ì‹œ
      xcargs: "-allowProvisioningUpdates " \
              "DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']} " \
              "CODE_SIGN_STYLE=Manual " \
              "CODE_SIGN_IDENTITY='Apple Distribution' " \
              "PROVISIONING_PROFILE_SPECIFIER='#{ENV['IOS_PROVISIONING_PROFILE_NAME']}'"
    )

    UI.success("âœ… IPA ë¹Œë“œ ì™„ë£Œ: build/ipa/Runner.ipa")
  end

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ì¸ì¦ì„œ ë° í”„ë¡œíŒŒì¼ ì •ë³´ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "í˜„ì¬ ì„¤ì •ëœ í™˜ê²½ë³€ìˆ˜ ë° ì¸ì¦ ì •ë³´ ì¶œë ¥"
  lane :debug_info do
    UI.header("í™˜ê²½ë³€ìˆ˜ ì •ë³´")
    UI.message("IOS_BUNDLE_ID: #{ENV['IOS_BUNDLE_ID'] || '(not set)'}")
    UI.message("APPLE_TEAM_ID: #{ENV['APPLE_TEAM_ID'] || '(not set)'}")
    UI.message("IOS_PROVISIONING_PROFILE_NAME: #{ENV['IOS_PROVISIONING_PROFILE_NAME'] || '(not set)'}")
    UI.message("APP_STORE_CONNECT_API_KEY_ID: #{ENV['APP_STORE_CONNECT_API_KEY_ID'] || '(not set)'}")
    UI.message("APP_STORE_CONNECT_ISSUER_ID: #{ENV['APP_STORE_CONNECT_ISSUER_ID'] || '(not set)'}")
    UI.message("API_KEY_PATH: #{ENV['API_KEY_PATH'] || '(not set)'}")

    # ì„¤ì¹˜ëœ í”„ë¡œíŒŒì¼ í™•ì¸
    UI.header("ì„¤ì¹˜ëœ Provisioning Profiles")
    profiles_path = File.expand_path("~/Library/MobileDevice/Provisioning Profiles")
    if Dir.exist?(profiles_path)
      Dir.glob("#{profiles_path}/*.mobileprovision").each do |profile|
        UI.message("  - #{File.basename(profile)}")
      end
    else
      UI.important("Provisioning Profiles ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤")
    end
  end

end
